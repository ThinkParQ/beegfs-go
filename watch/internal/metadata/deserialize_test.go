package metadata

import (
	"testing"

	"github.com/stretchr/testify/assert"
	pb "github.com/thinkparq/protobuf/go/beewatch"
)

func TestDeserialize(t *testing.T) {

	// This follows the table driven test pattern described here:
	// https://dave.cheney.net/2019/05/07/prefer-table-driven-tests

	type test struct {
		name  string
		input []byte
		want  pb.Event
	}

	// Note with format 1.0 events the type field in the input will be one less than the actual
	// event type.
	tests := []*test{
		{
			name: "With format version 1.0 unlink (remove) /hello",
			input: []byte{
				0x1, 0x0,
				0x0, 0x0,
				0x4b, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x9, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x39, 0x37, 0x33, 0x2d, 0x31, 0x0,
				0x4, 0x0, 0x0, 0x0,
				0x72, 0x6f, 0x6f, 0x74, 0x0,
				0x6, 0x0, 0x0, 0x0,
				0x2f, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 1,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_UNLINK,
				Path:               "/hello",
				EntryId:            "0-644C0973-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name:  "With format version 1.0 move (rename) /bar/foo to /foo",
			input: []byte{0x1, 0x0, 0x0, 0x0, 0x5d, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xb, 0x0, 0x0, 0x0, 0xc, 0x0, 0x0, 0x0, 0x30, 0x2d, 0x36, 0x34, 0x34, 0x42, 0x46, 0x46, 0x31, 0x46, 0x2d, 0x31, 0x0, 0xc, 0x0, 0x0, 0x0, 0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x30, 0x31, 0x42, 0x2d, 0x31, 0x0, 0x8, 0x0, 0x0, 0x0, 0x2f, 0x62, 0x61, 0x72, 0x2f, 0x66, 0x6f, 0x6f, 0x0, 0x4, 0x0, 0x0, 0x0, 0x2f, 0x66, 0x6f, 0x6f, 0x0, 0x4, 0x0, 0x0, 0x0, 0x72, 0x6f, 0x6f, 0x74, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 1,
				FormatVersionMinor: 0,
				Size:               93,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_RENAME,
				Path:               "/bar/foo",
				EntryId:            "0-644BFF1F-1",
				ParentEntryId:      "0-644C001B-1",
				TargetPath:         "/foo",
				TargetParentId:     "root",
			},
		}, {
			name:  "With format version 1.0 setAttr on /world with no dropped events and one missed event",
			input: []byte{0x1, 0x0, 0x0, 0x0, 0x4b, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2, 0x0, 0x0, 0x0, 0xc, 0x0, 0x0, 0x0, 0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x31, 0x30, 0x31, 0x37, 0x2d, 0x31, 0x0, 0x4, 0x0, 0x0, 0x0, 0x72, 0x6f, 0x6f, 0x74, 0x0, 0x6, 0x0, 0x0, 0x0, 0x2f, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 1,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         0,
				MissedSeq:          1,
				Type:               pb.Event_SETATTR,
				Path:               "/world",
				EntryId:            "0-644C1017-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name:  "With format version 1.0 close /world after write after 3 missed events",
			input: []byte{0x1, 0x0, 0x0, 0x0, 0x4b, 0x0, 0x0, 0x0, 0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x3, 0x0, 0x0, 0x0, 0xc, 0x0, 0x0, 0x0, 0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x31, 0x30, 0x31, 0x37, 0x2d, 0x31, 0x0, 0x4, 0x0, 0x0, 0x0, 0x72, 0x6f, 0x6f, 0x74, 0x0, 0x6, 0x0, 0x0, 0x0, 0x2f, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 1,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         3,
				MissedSeq:          0,
				Type:               pb.Event_CLOSE_WRITE,
				Path:               "/world",
				EntryId:            "0-644C1017-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name:  "With format version 2.0 create /world",
			input: []byte{0x2, 0x0, 0x0, 0x0, 0x4b, 0x0, 0x0, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x5, 0x0, 0x0, 0x0, 0xc, 0x0, 0x0, 0x0, 0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x31, 0x30, 0x31, 0x37, 0x2d, 0x31, 0x0, 0x4, 0x0, 0x0, 0x0, 0x72, 0x6f, 0x6f, 0x74, 0x0, 0x6, 0x0, 0x0, 0x0, 0x2f, 0x77, 0x6f, 0x72, 0x6c, 0x64, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 2,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_CREATE,
				Path:               "/world",
				EntryId:            "0-644C1017-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name: "With format version 2.0 open /hello for reading",
			input: []byte{
				0x2, 0x0,
				0x0, 0x0,
				0x4b, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0xd, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x39, 0x37, 0x33, 0x2d, 0x31, 0x0,
				0x4, 0x0, 0x0, 0x0,
				0x72, 0x6f, 0x6f, 0x74, 0x0,
				0x6, 0x0, 0x0, 0x0,
				0x2f, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 2,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_OPEN_READ,
				Path:               "/hello",
				EntryId:            "0-644C0973-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name: "With format version 2.0 last writer closed file h",
			input: []byte{
				0x2, 0x0,
				0x0, 0x0,
				0x46, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x10, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x39, 0x37, 0x33, 0x2d, 0x31, 0x0,
				0x4, 0x0, 0x0, 0x0,
				0x72, 0x6f, 0x6f, 0x74, 0x0,
				0x1, 0x0, 0x0, 0x0,
				0x68, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 2,
				FormatVersionMinor: 0,
				Size:               70,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_LAST_WRITER_CLOSED,
				Path:               "h",
				EntryId:            "0-644C0973-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		},
	}

	for _, tc := range tests {
		packet, err := deserialize(tc.input, len(tc.input))
		assert.NoError(t, err)
		assert.Equal(t, &tc.want, packet, tc.name)
	}

	// Note in these tests the "want" field is not actually used and is left to make it easier to
	// interpret the raw bytes of the input. For all of these tests what we "want" is an error.
	testErrorConditions := []*test{
		{
			name: "Format 1.0 events should not have a type greater than 12 after converting to the new format",
			input: []byte{
				0x1, 0x0,
				0x0, 0x0,
				0x4b, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x39, 0x37, 0x33, 0x2d, 0x31, 0x0,
				0x4, 0x0, 0x0, 0x0,
				0x72, 0x6f, 0x6f, 0x74, 0x0,
				0x6, 0x0, 0x0, 0x0,
				0x2f, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 1,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_OPEN_READ,
				Path:               "/hello",
				EntryId:            "0-644C0973-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name: "Event formats greater than 2.0 are not supported",
			input: []byte{
				0x2, 0x0,
				0x1, 0x0,
				0x4b, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x39, 0x37, 0x33, 0x2d, 0x31, 0x0,
				0x4, 0x0, 0x0, 0x0,
				0x72, 0x6f, 0x6f, 0x74, 0x0,
				0x6, 0x0, 0x0, 0x0,
				0x2f, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 2,
				FormatVersionMinor: 1,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_OPEN_READ,
				Path:               "/hello",
				EntryId:            "0-644C0973-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name: "Event format 2.0 does not support event type '0'",
			input: []byte{
				0x2, 0x0,
				0x0, 0x0,
				0x4b, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0,
				0xc, 0x0, 0x0, 0x0,
				0x30, 0x2d, 0x36, 0x34, 0x34, 0x43, 0x30, 0x39, 0x37, 0x33, 0x2d, 0x31, 0x0,
				0x4, 0x0, 0x0, 0x0,
				0x72, 0x6f, 0x6f, 0x74, 0x0,
				0x6, 0x0, 0x0, 0x0,
				0x2f, 0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0},
			want: pb.Event{
				FormatVersionMajor: 2,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_INVALID,
				Path:               "/hello",
				EntryId:            "0-644C0973-1",
				ParentEntryId:      "root",
				TargetPath:         "",
				TargetParentId:     "",
			},
		}, {
			name: "Error if the provided buffer is smaller than the size in the packet header",
			input: []byte{
				0x2, 0x0,
				0x0, 0x0,
				0x4b, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
				0x1, 0x0, 0x0, 0x0,
			},
			want: pb.Event{
				FormatVersionMajor: 2,
				FormatVersionMinor: 0,
				Size:               75,
				DroppedSeq:         1,
				MissedSeq:          0,
				Type:               pb.Event_FLUSH,
			},
		}, {
			name: "Error if the header is to small to deserialize",
			input: []byte{
				0x2, 0x0,
			},
			want: pb.Event{
				FormatVersionMajor: 2,
			},
		},
	}

	for _, tc := range testErrorConditions {
		_, err := deserialize(tc.input, len(tc.input))
		assert.Error(t, err)
	}

}
